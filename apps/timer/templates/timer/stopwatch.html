{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans "Stopwatch" %}{% endblock title %}

{% block content %}
<div class="max-w-2xl mx-auto">
  <!-- Header -->
  <div class="mb-8">
    <a href="{% url 'timer:home' %}" class="inline-flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors mb-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
      {% trans "Timer" %}
    </a>
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{% trans "Stopwatch" %}</h1>
    <p class="mt-1 text-gray-600 dark:text-gray-400">{% trans "Mark your times with flags" %}</p>
  </div>

  <!-- Timer Card -->
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-8">
    <div class="text-center mb-6 flex items-baseline justify-center font-mono font-bold tabular-nums tracking-tight">
      <span id="timerMain" class="text-5xl sm:text-6xl text-gray-900 dark:text-white" data-hours="0">00:00</span>
      <span id="timerMs" class="text-xl sm:text-2xl text-gray-400 dark:text-gray-500 ml-0.5">.00</span>
    </div>

    <div class="flex justify-center gap-3">
      <button id="playBtn" type="button" class="w-12 h-12 flex items-center justify-center bg-primary-600 hover:bg-primary-700 text-white rounded-full transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="6 3 20 12 6 21 6 3"/></svg>
      </button>
      <button id="pauseBtn" type="button" class="hidden w-12 h-12 flex items-center justify-center bg-primary-600 hover:bg-primary-700 text-white rounded-full transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="5" y="3" width="4" height="18" rx="1"/><rect x="15" y="3" width="4" height="18" rx="1"/></svg>
      </button>
      <button id="flagBtn" type="button" class="hidden w-12 h-12 flex items-center justify-center bg-primary-600 hover:bg-primary-700 text-white rounded-full transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
      </button>
      <button id="stopBtn" type="button" class="hidden w-12 h-12 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
      </button>
    </div>
  </div>

  <!-- Flags List -->
  <div id="flagsSection" class="hidden mt-4 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
    <h2 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">{% trans "Flags" %}</h2>
    <div id="flagsList" class="space-y-2"></div>
  </div>
</div>

{% csrf_token %}
<script src="{% static 'js/timer.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  var main = document.getElementById("timerMain"),
      ms = document.getElementById("timerMs"),
      btns = ["playBtn","pauseBtn","flagBtn","stopBtn"].map(function(id) { return document.getElementById(id); }),
      play = btns[0], pause = btns[1], flag = btns[2], stop = btns[3],
      flagsEl = document.getElementById("flagsSection"),
      listEl = document.getElementById("flagsList"),
      state = "idle", elapsed = 0, lastTick = null, afId = null,
      flags = [], lastFlagTime = 0;

  function tick(ts) {
    if (state !== "running") return;
    if (lastTick !== null) elapsed += ts - lastTick;
    lastTick = ts;
    updateTimerDisplay(main, ms, elapsed);
    afId = requestAnimationFrame(tick);
  }

  play.onclick = function() {
    if (state === "idle") track("start");
    state = "running"; lastTick = null;
    afId = requestAnimationFrame(tick);
    showButtons(btns, pause, flag);
  };

  pause.onclick = function() {
    state = "paused"; lastTick = null;
    if (afId) cancelAnimationFrame(afId);
    showButtons(btns, play, stop);
  };

  stop.onclick = function() {
    if (elapsed > 0) track("stop", elapsed);
    state = "idle"; lastTick = null;
    if (afId) cancelAnimationFrame(afId);
    elapsed = 0; flags = []; lastFlagTime = 0;
    listEl.innerHTML = "";
    flagsEl.classList.add("hidden");
    updateTimerDisplay(main, ms, 0);
    showButtons(btns, play);
  };

  flag.onclick = function() {
    track("flag");
    var lap = elapsed - lastFlagTime;
    flags.push(elapsed); lastFlagTime = elapsed;
    flagsEl.classList.remove("hidden");
    var t = formatTime(elapsed), l = formatTime(lap), row = document.createElement("div");
    row.className = "flex items-center justify-between px-4 py-2.5 bg-gray-50 dark:bg-gray-700/50 rounded-lg";
    row.innerHTML =
      '<div class="flex items-center gap-3"><span class="text-xs font-semibold text-gray-400 dark:text-gray-500 w-6">#' + flags.length + '</span>' +
      '<span class="font-mono text-sm text-gray-900 dark:text-white">' + t.main + '<span class="text-gray-400 dark:text-gray-500">.' + t.cs + '</span></span></div>' +
      '<span class="font-mono text-sm text-gray-500 dark:text-gray-400">+' + l.main + '.' + l.cs + '</span>';
    listEl.prepend(row);
  };
});
</script>
{% endblock content %}
