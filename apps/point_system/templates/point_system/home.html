{% extends "base.html" %}
{% load custom_tags %}

{% block title %}Points System{% endblock title %}

{% block content %}
<div class="max-w-6xl mx-auto">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Points System</h1>
    <p class="mt-1 text-gray-600 dark:text-gray-400">Track positive and negative points for group members</p>
  </div>

  <!-- Group Selection Card -->
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
    <form method="GET" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
          Select a group
        </label>
        <input type="hidden" name="group_id" id="groupSelect" value="{% if selected_group %}{{ selected_group.id }}{% endif %}" required>
        <div class="relative z-20" id="groupDropdown">
          <button type="button" id="groupBtn" class="w-full px-4 py-2.5 pr-10 bg-gray-50 dark:bg-gray-700 rounded-lg text-gray-900 dark:text-white transition-colors cursor-pointer text-left">
            <span id="groupBtnText">{% if selected_group %}{{ selected_group.title }} ({{ selected_group.size }} members){% else %}Choose a group...{% endif %}</span>
          </button>
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <svg id="groupChevron" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
          <div id="groupOptions" class="hidden absolute z-50 w-full mt-1 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-lg overflow-hidden max-h-60 overflow-y-auto">
            {% for group in groups %}
            <div class="group-option px-4 py-2.5 text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer {% if forloop.last %}rounded-b-lg{% endif %}" data-value="{{ group.id }}" data-text="{{ group.title }} ({{ group.size }} members)">{{ group.title }} ({{ group.size }} members)</div>
            {% empty %}
            <div class="px-4 py-2.5 text-gray-500 dark:text-gray-400">No groups available</div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="flex flex-wrap gap-3">
        <button type="submit" class="px-5 py-2.5 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors">
          Show Points
        </button>
        {% if selected_group %}
        <a href="{% url 'karma:karma-home' %}" class="px-5 py-2.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors">
          Reset
        </a>
        <a id="editGroupsBtn" href="#" class="px-5 py-2.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors">
          Edit Group
        </a>
        {% endif %}
        <a href="{% url 'group_maker:group-maker-creation' %}" class="px-5 py-2.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors">
          Create Group
        </a>
      </div>
    </form>
  </div>

  {% if selected_group %}
  <form method="POST">
    {% csrf_token %}
    <input type="hidden" name="group_id" value="{{ group_id }}">

    <!-- Negative Points Table -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
        <span class="w-3 h-3 bg-red-500 rounded-full"></span>
        Negative Points
      </h2>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-100 dark:bg-gray-700">
            <tr>
              <th class="text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-tl-lg">Name</th>
              {% for key in negative_data %}
              <th class="text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300">{{ key }}</th>
              {% endfor %}
              <th class="text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-tr-lg">Total</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            {% for member in members %}
            <tr class="{% if member.negative_total >= 10 %}bg-red-50 dark:bg-red-900/20{% elif member.negative_total >= 5 %}bg-orange-50 dark:bg-orange-900/20{% endif %} {% if forloop.last %}last-row{% endif %}">
              <td class="py-3 px-4">
                <a href="{% url 'karma:karma-dashboard' member.id %}" class="text-primary-600 dark:text-primary-400 hover:underline font-medium">
                  {{ member.name }}
                </a>
              </td>
              {% for column in negative_data %}
              <td class="py-3 px-4">
                <input type="{{ column_type_negative|get_item:column }}"
                       name="{{ member.id }}_negative_{{ column }}"
                       value="{{ member.negative_data|get_item:column }}"
                       min="0"
                       class="w-20 px-3 py-1.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
              </td>
              {% endfor %}
              <td class="py-3 px-4">
                <span class="font-semibold {% if member.negative_total >= 10 %}text-red-600 dark:text-red-400{% elif member.negative_total >= 5 %}text-orange-600 dark:text-orange-400{% else %}text-gray-900 dark:text-white{% endif %}">
                  {{ member.negative_total }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="flex flex-wrap gap-3 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
        {% if negative_data %}
        <button type="submit" name="negative_save" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors text-sm">
          Save Points
        </button>
        <a href="?group_id={{ group_id }}" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors text-sm">
          Cancel
        </a>
        <a href="{% url 'karma:new-column' selected_group.id %}?table=negative" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors text-sm">
          Add Column
        </a>
        <a href="{% url 'karma:edit-column' selected_group.id %}?table=negative" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors text-sm">
          Edit Column
        </a>
        <a href="{% url 'karma:delete-column' selected_group.id %}?table=negative" class="px-4 py-2 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400 font-medium rounded-lg transition-colors text-sm">
          Delete Column
        </a>
        {% else %}
        <a href="{% url 'karma:new-column' selected_group.id %}?table=negative" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors text-sm">
          Add First Column
        </a>
        {% endif %}
      </div>
    </div>

    <!-- Positive Points Table -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
        <span class="w-3 h-3 bg-green-500 rounded-full"></span>
        Positive Points
      </h2>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-100 dark:bg-gray-700">
            <tr>
              <th class="text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-tl-lg">Name</th>
              {% for key in positive_data %}
              <th class="text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300">{{ key }}</th>
              {% endfor %}
              <th class="text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-tr-lg">Total</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            {% for member in members %}
            <tr class="{% if member.positive_total >= 10 %}bg-green-50 dark:bg-green-900/20{% elif member.positive_total >= 5 %}bg-emerald-50 dark:bg-emerald-900/20{% endif %} {% if forloop.last %}last-row{% endif %}">
              <td class="py-3 px-4">
                <a href="{% url 'karma:karma-dashboard' member.id %}" class="text-primary-600 dark:text-primary-400 hover:underline font-medium">
                  {{ member.name }}
                </a>
              </td>
              {% for column in positive_data %}
              <td class="py-3 px-4">
                <input type="{{ column_type_positive|get_item:column }}"
                       name="{{ member.id }}_positive_{{ column }}"
                       value="{{ member.positive_data|get_item:column }}"
                       min="0"
                       class="w-20 px-3 py-1.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
              </td>
              {% endfor %}
              <td class="py-3 px-4">
                <span class="font-semibold {% if member.positive_total >= 10 %}text-green-600 dark:text-green-400{% elif member.positive_total >= 5 %}text-emerald-600 dark:text-emerald-400{% else %}text-gray-900 dark:text-white{% endif %}">
                  {{ member.positive_total }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="flex flex-wrap gap-3 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
        {% if positive_data %}
        <button type="submit" name="positive_save" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors text-sm">
          Save Points
        </button>
        <a href="?group_id={{ group_id }}" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors text-sm">
          Cancel
        </a>
        <a href="{% url 'karma:new-column' selected_group.id %}?table=positive" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors text-sm">
          Add Column
        </a>
        <a href="{% url 'karma:edit-column' selected_group.id %}?table=positive" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors text-sm">
          Edit Column
        </a>
        <a href="{% url 'karma:delete-column' selected_group.id %}?table=positive" class="px-4 py-2 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400 font-medium rounded-lg transition-colors text-sm">
          Delete Column
        </a>
        {% else %}
        <a href="{% url 'karma:new-column' selected_group.id %}?table=positive" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors text-sm">
          Add First Column
        </a>
        {% endif %}
      </div>
    </div>
  </form>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const groupBtn = document.getElementById("groupBtn");
    const groupOptions = document.getElementById("groupOptions");
    const groupSelect = document.getElementById("groupSelect");
    const groupBtnText = document.getElementById("groupBtnText");
    const groupChevron = document.getElementById("groupChevron");
    const editBtn = document.getElementById("editGroupsBtn");

    groupBtn.addEventListener("click", () => {
      groupOptions.classList.toggle("hidden");
      groupChevron.classList.toggle("rotate-180");
    });

    document.querySelectorAll(".group-option").forEach(option => {
      option.addEventListener("click", () => {
        groupSelect.value = option.dataset.value;
        groupBtnText.textContent = option.dataset.text;
        groupOptions.classList.add("hidden");
        groupChevron.classList.remove("rotate-180");
        updateEditLink();
      });
    });

    document.addEventListener("click", (e) => {
      if (!document.getElementById("groupDropdown").contains(e.target)) {
        groupOptions.classList.add("hidden");
        groupChevron.classList.remove("rotate-180");
      }
    });

    function updateEditLink() {
      if (editBtn) {
        const groupId = groupSelect.value;
        if (groupId) {
          editBtn.href = "{% url 'group_maker:group-maker-edit' 0 %}".replace("0", groupId) + "?from=point-system";
          editBtn.classList.remove("opacity-50", "cursor-not-allowed", "pointer-events-none");
        } else {
          editBtn.href = "#";
          editBtn.classList.add("opacity-50", "cursor-not-allowed", "pointer-events-none");
        }
      }
    }

    updateEditLink();
  });
</script>
{% endblock content %}
