{% extends "base.html" %}

{% block title %}Group Divider{% endblock title %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Group Divider</h1>
    <p class="mt-1 text-gray-600 dark:text-gray-400">Split your group into smaller teams</p>
  </div>

  <!-- Form Card -->
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
    <form method="POST">
      {% csrf_token %}

      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Select a group</label>
        <input type="hidden" name="group_id" id="groupSelect" value="{% if selected_group %}{{ selected_group.id }}{% endif %}" required>
        <div class="relative z-20" id="groupDropdown">
          <button type="button" id="groupBtn" class="w-full px-4 py-2.5 pr-10 bg-gray-50 dark:bg-gray-700 rounded-lg text-gray-900 dark:text-white transition-colors cursor-pointer text-left">
            <span id="groupBtnText">{% if selected_group %}{{ selected_group.title }} ({{ selected_group.size }} members){% else %}Select a group{% endif %}</span>
          </button>
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <svg id="groupChevron" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
          <div id="groupOptions" class="hidden absolute z-50 w-full mt-1 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-lg overflow-hidden max-h-60 overflow-y-auto">
            {% for group in groups %}
            <div class="group-option px-4 py-2.5 text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer {% if forloop.last %}rounded-b-lg{% endif %}" data-value="{{ group.id }}" data-text="{{ group.title }} ({{ group.size }} members)">{{ group.title }} ({{ group.size }} members)</div>
            {% empty %}
            <div class="px-4 py-2.5 text-gray-500 dark:text-gray-400">No groups available</div>
            {% endfor %}
          </div>
        </div>
      </div>
      <br>
      <div>
        <label for="{{ form.size.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
          {{ form.size.label }}
        </label>
        <input type="number" name="size" id="{{ form.size.id_for_label }}" value="{{ form.size.value|default:'' }}"
               class="w-full px-4 py-2.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
               min="1" required>
        {% if form.size.help_text %}
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.size.help_text }}</p>
        {% endif %}
        {% if form.size.errors %}
        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.size.errors.0 }}</p>
        {% endif %}
      </div>

      <div class="flex flex-wrap gap-3 pt-2">
        <button type="submit" class="px-5 py-2.5 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors">
          Divide
        </button>
        <a href="{% url 'group_maker:group-maker-creation' %}?next={% url 'group_divider:home' %}" class="px-5 py-2.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors">
          Create Group
        </a>
        <a href="{% url 'group_divider:home' %}" class="px-5 py-2.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors">
          Reset
        </a>
        <a id="editGroupsBtn" href="{% if selected_group %}{% url 'group_maker:group-maker-edit' selected_group.id %}{% else %}#{% endif %}"
           class="px-5 py-2.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors {% if not selected_group %}opacity-50 pointer-events-none{% endif %}">
          Edit Group
        </a>
      </div>
    </form>
  </div>

  {% if splitted_group %}
  <!-- Results -->
  <div class="mt-8">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      Divided Groups <span class="text-gray-500 dark:text-gray-400 font-normal">({{ selected_group.title }})</span>
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for group in splitted_group %}
      <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="px-4 py-3 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700">
          <h3 class="font-semibold text-gray-900 dark:text-white">Group {{ forloop.counter }}</h3>
        </div>
        <ul class="divide-y divide-gray-200 dark:divide-gray-700">
          {% for member in group %}
          <li class="px-4 py-2.5 text-sm text-gray-700 dark:text-gray-300">{{ member.name }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const groupBtn = document.getElementById("groupBtn");
  const groupOptions = document.getElementById("groupOptions");
  const groupSelect = document.getElementById("groupSelect");
  const groupBtnText = document.getElementById("groupBtnText");
  const groupChevron = document.getElementById("groupChevron");
  const editBtn = document.getElementById("editGroupsBtn");
  const baseUrl = "{% url 'group_maker:group-maker-edit' 0 %}?from=group-divider";

  groupBtn.addEventListener("click", () => {
    groupOptions.classList.toggle("hidden");
    groupChevron.classList.toggle("rotate-180");
  });

  document.querySelectorAll(".group-option").forEach(option => {
    option.addEventListener("click", () => {
      groupSelect.value = option.dataset.value;
      groupBtnText.textContent = option.dataset.text;
      groupOptions.classList.add("hidden");
      groupChevron.classList.remove("rotate-180");
      updateEditLink();
    });
  });

  document.addEventListener("click", (e) => {
    if (!document.getElementById("groupDropdown").contains(e.target)) {
      groupOptions.classList.add("hidden");
      groupChevron.classList.remove("rotate-180");
    }
  });

  function updateEditLink() {
    const groupId = groupSelect.value;
    if (groupId) {
      editBtn.href = baseUrl.replace("0", groupId);
      editBtn.classList.remove("opacity-50", "pointer-events-none");
    } else {
      editBtn.href = "#";
      editBtn.classList.add("opacity-50", "pointer-events-none");
    }
  }

  updateEditLink();
});
</script>
{% endblock content %}
