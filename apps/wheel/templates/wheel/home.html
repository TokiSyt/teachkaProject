{% extends "base.html" %}

{% block title %}Name Wheel{% endblock title %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Name Wheel</h1>
    <p class="mt-1 text-gray-600 dark:text-gray-400">Randomly select a name from your group</p>
  </div>

  <!-- Form Card -->
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
    <form method="POST">
      {% csrf_token %}

      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Select a group</label>
        <input type="hidden" name="group_id" id="groupSelect" value="{% if selected_group %}{{ selected_group.id }}{% endif %}" required>
        <div class="relative z-20" id="groupDropdown">
          <button type="button" id="groupBtn" class="w-full px-4 py-2.5 pr-10 bg-gray-50 dark:bg-gray-700 rounded-lg text-gray-900 dark:text-white transition-colors cursor-pointer text-left">
            <span id="groupBtnText">{% if selected_group %}{{ selected_group.title }} ({{ selected_group.size }} members){% else %}Select a group{% endif %}</span>
          </button>
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <svg id="groupChevron" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
          <div id="groupOptions" class="hidden absolute z-50 w-full mt-1 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-lg overflow-hidden max-h-60 overflow-y-auto">
            {% for group in groups %}
            <div class="group-option px-4 py-2.5 text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer {% if forloop.last %}rounded-b-lg{% endif %}" data-value="{{ group.id }}" data-text="{{ group.title }} ({{ group.size }} members)">{{ group.title }} ({{ group.size }} members)</div>
            {% empty %}
            <div class="px-4 py-2.5 text-gray-500 dark:text-gray-400">No groups available</div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 pt-2">
        <button type="submit" class="px-5 py-2.5 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors">
          Spin
        </button>
        <a href="{% url 'wheel:home' %}?reset=1{% if selected_group %}&group_id={{ selected_group.id }}{% endif %}" class="px-5 py-2.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors">
          Reset
        </a>
        <a id="editGroupsBtn" href="{% if selected_group %}{% url 'group_maker:group-maker-edit' selected_group.id %}{% else %}#{% endif %}"
           class="px-5 py-2.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors {% if not selected_group %}opacity-50 pointer-events-none{% endif %}">
          Edit Group
        </a>
      </div>
    </form>
  </div>

  {% if chosen_member %}
  <!-- Chosen Name Display -->
  <div class="mt-8 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-8 sm:p-12 text-center shadow-lg">
    <p class="text-gray-500 dark:text-gray-400 text-sm font-medium uppercase tracking-wider mb-2">Selected</p>
    <p class="text-4xl sm:text-6xl md:text-8xl font-bold text-primary-600 dark:text-primary-400 break-words">{{ chosen_member.name }}</p>
  </div>
  {% endif %}

  {% if message %}
  <!-- Message Display -->
  <div class="mt-8 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-2xl p-8 text-center">
    <p class="text-lg font-medium text-amber-800 dark:text-amber-200">{{ message }}</p>
  </div>
  {% endif %}

  {% if already_chosen_members %}
  <!-- Already Chosen List -->
  <div class="mt-8">
    <h2 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">Already Chosen ({{ already_chosen_members|length }})</h2>
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
      <ul class="divide-y divide-gray-200 dark:divide-gray-700">
        {% for member in already_chosen_members %}
        <li class="px-4 py-2.5 text-sm text-gray-600 dark:text-gray-400">{{ member.name }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const groupBtn = document.getElementById("groupBtn");
  const groupOptions = document.getElementById("groupOptions");
  const groupSelect = document.getElementById("groupSelect");
  const groupBtnText = document.getElementById("groupBtnText");
  const groupChevron = document.getElementById("groupChevron");
  const editBtn = document.getElementById("editGroupsBtn");
  const baseUrl = "{% url 'group_maker:group-maker-edit' 0 %}?from=name-wheel";

  groupBtn.addEventListener("click", () => {
    groupOptions.classList.toggle("hidden");
    groupChevron.classList.toggle("rotate-180");
  });

  document.querySelectorAll(".group-option").forEach(option => {
    option.addEventListener("click", () => {
      groupSelect.value = option.dataset.value;
      groupBtnText.textContent = option.dataset.text;
      groupOptions.classList.add("hidden");
      groupChevron.classList.remove("rotate-180");
      updateEditLink();
    });
  });

  document.addEventListener("click", (e) => {
    if (!document.getElementById("groupDropdown").contains(e.target)) {
      groupOptions.classList.add("hidden");
      groupChevron.classList.remove("rotate-180");
    }
  });

  function updateEditLink() {
    const groupId = groupSelect.value;
    if (groupId) {
      editBtn.href = baseUrl.replace("0", groupId);
      editBtn.classList.remove("opacity-50", "pointer-events-none");
    } else {
      editBtn.href = "#";
      editBtn.classList.add("opacity-50", "pointer-events-none");
    }
  }

  updateEditLink();
});
</script>
{% endblock content %}
